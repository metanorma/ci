name: test-composite

on:
  push:
    branches: [ master, main ]
  pull_request:

jobs:
  test-scripts:
    name: Test scripts
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        experimental: [ false ]
    steps:
      - uses: actions/checkout@v3

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - run: ./gemver-to-semver.rb --self-test
  test-composite:
    name: Test composite actions ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        experimental: [ false ]
    steps:
      - uses: actions/checkout@v3

      - uses: ./graphviz-setup-action
      - run: dot -V

      - uses: ./inkscape-setup-action
      - run: inkscape --version

      - uses: ./libreoffice-setup-action
      - if: matrix.os != 'macos-latest'
        run: soffice --version

      - uses: ./plantuml-setup-action
      - run: plantuml -version

  test-native-deps-action:
    name: Test native-deps-action ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: ubuntu-latest
          library: /usr/bin/login
        - os: windows-latest
          library: C:\WINDOWS\System32\KERNELBASE.dll
        - os: macos-latest
          library: /usr/bin/login
    steps:
      - uses: actions/checkout@v3

      - uses: ./native-deps-action
        with:
          filepath: ${{ matrix.library }}

  test-bundler-docker-gh-rubygem-setup-action:
    name: Test gh-rubygems-setup-action & docker-gem-install in docker
    runs-on: ubuntu-latest
    container: docker://metanorma/metanorma
    steps:
      - uses: actions/checkout@v3

      - uses: ./gh-rubygems-setup-action
        with:
          token: ${{ secrets.METANORMA_CI_PAT_TOKEN }}

      - run: |
          echo 'gem "metanorma-cli"' > Gemfile
          echo 'gem "metanorma", "~>1"' >> Gemfile
          echo 'gem "metanorma-nist", source: "https://rubygems.pkg.github.com/metanorma"' >> Gemfile
          echo 'gem "metanorma-standoc", git: "https://github.com/metanorma/metanorma-standoc", branch: "main"' >> Gemfile

      - run: apt-get update -y && apt-get install -y gcc g++ ruby-dev

      - uses: ./docker-gem-install

  test-gem-docker-gh-rubygem-setup-action:
    name: Test gh-rubygems-setup-action & docker-gem-install in docker
    runs-on: ubuntu-latest
    container: docker://metanorma/metanorma
    steps:
      - uses: actions/checkout@v3

      - uses: ./gh-rubygems-setup-action
        with:
          token: ${{ secrets.METANORMA_CI_PAT_TOKEN }}

      - shell: bash
        run: |
          for gem in metanorma-cli metanorma-nist; do
            [[ "$(gem info --remote $gem)" =~ "$gem" ]] || (echo "Error gem '$gem' not found" && exit 1)
          done

  test-bundler-gh-rubygem-setup-action:
    name: Test gh-rubygems-setup-action
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - uses: ./gh-rubygems-setup-action
        with:
          token: dummy_token

      - uses: chrisdickinson/setup-yq@latest
        with:
          yq-version: v4.30.4

      - run: |
          yq -e e '.["BUNDLE_HTTPS://RUBYGEMS__PKG__GITHUB__COM/METANORMA/"] == "x-access-token:dummy_token"' ~/.bundle/config
          yq -e e '.[":sources"] | length == 2' ~/.gemrc

      - run: |
          env
          [ ${BUNDLE_GITHUB__COM} = "x-access-token:dummy_token" ] || exit 1
          [ ${BUNDLE_RUBYGEMS__PKG__GITHUB__COM} = "x-access-token:dummy_token" ] || exit 1

  test-latexml-setup-action:
    name: Test latexml-setup-action ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v3

      - uses: ./latexml-setup-action

      - run: latexmlmath --VERSION
 
  test-change-tmpdir-action:
    name: Test change-tmpdir-action ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v3

      - uses: ./change-tmpdir-action
        with:
          tmpdir: ${{ github.workspace }}/tmp

      - run: env
        shell: bash